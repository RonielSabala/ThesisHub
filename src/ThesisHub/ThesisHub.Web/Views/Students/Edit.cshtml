@model StudentViewModel

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Student</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <input type="hidden" id="modelId" value="@Model.Id" />

        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="form-group">
            <label class="control-label">First name</label>
            <input class="form-control" id="firstName" />
        </div>

        <div class="form-group">
            <label class="control-label">Last name</label>
            <input class="form-control" id="lastName" />
        </div>

        <div class="form-group">
            <label class="control-label">Email</label>
            <input class="form-control" id="email" />
        </div>

        <div class="form-group">
            <label class="control-label">Phone</label>
            <input class="form-control" id="phone" />
        </div>

        <div class="form-group">
            <label class="control-label">Department</label>
            <select id="departmentId" class="form-control"></select>
        </div>

        @* Save button *@
        <div class="form-group">
            <button onclick="updateStudent()" class="btn btn-primary">Update</button>
        </div>

    </div>
</div>

<a asp-action="Index">Back to List</a>

@section Scripts {
<script>
    let modelDeptId = -1;

    $(document).ready(function () {
        loadStudent(@Model.Id);
        loadSelect();
    });

    function loadStudent(id) {
        $.get(`${studentAPI}/Get/${id}`, function (entity) {
            $("#firstName").val(entity.firstName);
            $("#lastName").val(entity.lastName);
            $("#email").val(entity.email);
            $("#phone").val(entity.phone);
            modelDeptId = entity.departmentId;
        });
    }

    function loadSelect() {
        $.ajax({
            url: `${departmentAPI}/GetAll`,
            type: "GET",
            success: function (deptEntities) {
                const $select = $("#departmentId");
                $select.empty();

                let firstOption = "";
                let otherOptions = [];

                $.each(deptEntities, function (i, deptEntity) {
                    let option = `<option value="${deptEntity.id}">${deptEntity.deptName}</option>`;

                    if (deptEntity.id == modelDeptId) {
                        firstOption = option;
                    } else {
                        otherOptions.push(option);
                    }
                });

                $select.append(firstOption);
                $.each(otherOptions, function (i, option) {
                    $select.append(option);
                });
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", status, error);
                alert("An error occurred. Please try again.");
            }
        });
    }

    function updateStudent() {
        let entity = {
            id: $("#modelId").val(),
            firstName: $("#firstName").val(),
            lastName: $("#lastName").val(),
            email: $("#email").val(),
            phone: $("#phone").val(),
            departmentId: $("#departmentId").val()
        };

        $.ajax({
            url: `${studentAPI}/Update`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify(entity),
            success: function (response) {
                if (response.success) {
                    window.location.href = "/Students/Index";
                } else {
                    alert("Error: " + response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", status, error);
                alert("An error occurred. Please try again.");
            }
        });
    }
</script>
}